<?php
session_start();
require_once 'mysql_parameter.php';
// connect to database
$db = mysqli_connect($hn, $un, $pw, $db, $port);
if ($db->connect_error) die($db->connect_error);
if (isset($_POST['login_btn'])) {

    $username = mysql_entities_fix_string($db, $_POST['username']);
    $password = mysql_entities_fix_string($db, $_POST['password']);

	$token = hash('ripemd128', "$salt1$password$salt2");
    $sql = "SELECT * FROM users WHERE username = '$username' AND password = '$token'";

    $result = mysqli_query($db, $sql);

    if (mysqli_num_rows($result) == 1) {

        $_SESSION['message'] = "You are now logged in";
        $_SESSION['username'] = $username;
        $_SESSION['role'] = "user";
        header("location: home.php");
    } else {
        $_SESSION['message'] = "Username/password combination incorrect.";
    }

    $result->close();
}

if (isset($_POST['loginAdmin_btn'])) {
    
    $username = mysql_entities_fix_string($db, $_POST['username']);
    $password = mysql_entities_fix_string($db, $_POST['password']);
    
    $token = hash('ripemd128', "$salt1$password$salt2");
    $sql = "SELECT * FROM admins WHERE username = '$username' AND password = '$token'";
    
    $result = mysqli_query($db, $sql);
    
    if (mysqli_num_rows($result) == 1) {
        
        $_SESSION['message'] = "You are now logged in";
        $_SESSION['username'] = $username;
        $_SESSION['role'] = "admin";
        header("location: admin_dashboard.php");
    } else {
        $_SESSION['message'] = "Username/password combination incorrect.";
    }

    $result->close();
}

if (isset($_POST['loginContributor_btn'])) {
    
    $username = mysql_entities_fix_string($db, $_POST['username']);
    $password = mysql_entities_fix_string($db, $_POST['password']);
    
    $token = hash('ripemd128', "$salt1$password$salt2");
    $sql = "SELECT * FROM contributors WHERE username = '$username' AND password = '$token'";
    
    $result = mysqli_query($db, $sql);
    
    if (mysqli_num_rows($result) == 1) {
        
        $_SESSION['message'] = "You are now logged in";
        $_SESSION['username'] = $username;
        $_SESSION['role'] = "contributor";
        header("location: contributor.php");
    } else {
        $_SESSION['message'] = "Username/password combination incorrect.";
    }

    $result->close();
}

echo <<<_END
    <!DOCTYPE html>
    <html>
    <head>
    <title>Online Virus Check</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <div class="header">
            <h1>Online Virus Check</h1>
        </div>
_END;

if (isset($_SESSION['message'])) {
    echo "<div id='error_msg'>".$_SESSION['message']."</div>";
    unset($_SESSION['message']);
}

echo <<<_END
	<form method="post" action="login.php">
		<table>
			<tr>
				<td>Username:</td>
				<td><input type="text" name="username" class="textInput"></td>
			</tr>

			<tr>
				<td>Password:</td>
				<td><input type="password" name="password" class="textInput"></td>
			</tr>

            

			<tr>
				<td><a href="register.php">Sign Up</a></td>
				<td><input type="submit" name="login_btn" value="Login">
                <input type="submit" name="loginAdmin_btn" value="Login as Admin">
                <input type="submit" name="loginContributor_btn" value="Login as Contributor"></td>
			</tr>

		</table>
	</form>



</body>
</html>
_END;

function mysql_entities_fix_string($conn, $string)
{
    return htmlentities(mysql_fix_string($conn, $string));
}

function mysql_fix_string($conn, $string)
{
    if (get_magic_quotes_gpc()) $string = stripslashes($string);
    return $conn->real_escape_string($string);
}
?>