<?php
session_start();
require_once 'mysql_parameter.php';

// connect to database
$conn = mysqli_connect($hn, $un, $pw, $db, $port);
if ($conn->connect_error) die($conn->connect_error);

$role = $_SESSION['role'];
if( $role == "user" ) {

    // Html form for uploading and rename the file
    echo <<<_END
            <html>
                <head>
                    <title>Online Virus Check</title>
                    <link rel="stylesheet" type="text/css" href="style.css">
                </head>
                <body>
                    <div class="header">
                        <h1>Online Virus Check</h1>
                    </div>
_END;
    if (isset($_SESSION['message'])) {
        echo "<div id='error_msg'>" . $_SESSION['message'] . "</div>";
        unset($_SESSION['message']);
    }
    echo <<<_END
                    <form action="" method="POST" enctype="multipart/form-data">
		Select a File that you would like to check is malware: <input type="file" name="file" />
		<input type="submit" name="file_submit" />

	</form>
                    <form class="logout" action="logout.php">
                            <input type="submit" name="logout" value="Logout" />
                    </form>

                </body>
            </html>
_END;

if (isset($_POST['file_submit'])) { // only txt files!!
    
    if (isset($_FILES['file'])) {
        
            $errors = array();
            $file_name = $_FILES['file']['name'];
            $file_size = $_FILES['file']['size'];
            $file_tmp = $_FILES['file']['tmp_name'];
            $file_type = $_FILES['file']['type'];
            $file_ext = strtolower(end(explode('.', $_FILES['file']['name'])));
            
            
            
            
            // $extensions= array("jpeg","jpg","png");
            
            // if(in_array($file_ext,$extensions)=== false){
            // $errors[]="extension not allowed, please choose a JPEG or PNG file.";
            // }
            
            if ($file_size > 2097152) {
                $errors[] = 'File size must be less than 2 MB';
            }
            
            if (empty($errors) == true) {
                
                $putativeFileName = $_FILES['file']['tmp_name'];
                $fh = fopen ($putativeFileName, "rb");
                $putativeFileData = fread ($fh, filesize($putativeFileName));
                $putativeFileData = base64_encode($putativeFileData);
                
                //get list of signatures in database, 20 bytes
                $dbSignatures = array();
                $query = "SELECT bytes FROM malwares";
                $result = $conn->query($query);
                
                if (!$result) die($conn->error);
                
                $rows = $result->num_rows;
                for ($j = 0 ; $j < $rows ; ++$j)
                {
                    $result->data_seek($j);
                    $row = $result->fetch_array(MYSQLI_NUM);
                    
                    $dbSignatures[count($dbSignatures)] = $row[0];
                    
                }
                
                if(returnIsMalware($putativeFileData, $dbSignatures)){
                    echo "IS MALWARE UH OH <br>";
                    
                } else {
                    echo "Not Malware :) <br>";
                }
               
            } else {
                print_r($errors);
            }
        }
    }

} else {
    header("location:login.php");
    exit;
}


function returnIsMalware($putativeFileData, $dbSignatures){
    
    
    //for element in list
    foreach ($dbSignatures as $sig) {
        
        if (strpos($putativeFileData, $sig) !== false){
            return true;
        }
        
        
    }
    //if putativefiledata contains element --> is malware
    return false;
    
}
?>
