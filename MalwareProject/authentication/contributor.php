<?php

    session_start();
    require_once 'mysql_parameter.php';
    // connect to database
    $conn = mysqli_connect($hn, $un, $pw, $db, $port);
    if ($conn->connect_error) die($conn->connect_error);

    // store user input and text content to database
    if (isset($_FILES['file']) && isset($_POST['malware_name']) || isset($_POST['sequence_of_bytes']))
    {
        // check the file is whether uploaded or not
        if ($_FILES['file']['tmp_name'] === '' || $_POST['malware_name'] === '' || $_POST['sequence_of_bytes'] === '')
        {
            $_SESSION['message'] = "Please upload a text file, enter a new file name and sequence of bytes.";
        }
        else
        {
            switch($_FILES['file']['type']) {
                case 'text/plain'	: $ext = 'txt'; break;
                default			    : $ext = ''   ; break;
            }
            if ($ext) {			//acceptable extention "txt"
                $str = file_get_contents($_FILES['file']['tmp_name']);
                $content = mysqli_real_escape_string($conn, $str);
                $malware_name = get_post($conn, 'malware_name');
                $sequence_of_bytes = get_post($conn, 'sequence_of_bytes');
                $username = $_SESSION['username'];
    
                $query = "INSERT INTO contributedmalwares (name, bytes, content, username) VALUES " .
                    "('$malware_name', '$sequence_of_bytes', '$content', '$username')";
                $upload_result = $conn->query($query);
    
                if (!$upload_result)
                {
                    echo "INSERT failed.<br>" . $conn->error . "<br><br>";
                }
                else{
                    header("location:contributor.php");
                    exit;
                }
            }
            else echo "Error: The file you upload is not an accepted text file."; 
        }
    }

    // check whether user is in a login status
    if (isset($_SESSION['username']))
    {
        // Html form for uploading and rename the file
        echo <<<_END
        <html>
            <head>
                <title>Online Virus Check</title>
                <link rel="stylesheet" type="text/css" href="style.css">
            </head>
            <body>
                <div class="header">
                    <h1>Online Virus Check</h1>
                </div>
_END;
                if (isset($_SESSION['message'])) {
                    echo "<div id='error_msg'>" . $_SESSION['message'] . "</div>";
                    unset($_SESSION['message']);
                }
        echo <<<_END
                <form action="contributor.php" method="post" enctype="multipart/form-data">
                        <input type="file" name="file">
                        <br>
                        <br>
                        Malware name:
                        <input type="text" name="malware_name">
                        <br>
                        <br>
                        Sequence of bytes:
                        <input type="text" name="sequence_of_bytes">
                        <br>
                        <br>
                        <input type="submit" value="Submit">
                </form>
                <form class="logout" action="logout.php">
                        <input type="submit" name="logout" value="Logout" />
                </form>
            </body>
        </html>
_END;
        $username = $_SESSION['username'];
        
        // print out all the file from database
        $query = "SELECT * FROM contributedmalwares WHERE username = '$username'";
        $result = $conn->query($query);
        if (!$result) die($conn->error);

        $rows = $result->num_rows;

        echo	"<div class='container'><table><tr><th>Malware name</th><th>Sequence of bytes</th><th>Content</th><th>Upload user</th><th>Status</th></tr>";
        for ($j = 0 ; $j < $rows ; ++$j)
        {
            $result->data_seek($j);
            $row = $result->fetch_array(MYSQLI_NUM);
            echo "<tr>";

            for ($k = 1 ; $k <= 5 ; ++$k) echo "<td>$row[$k]</td>";
            echo "</tr>";
        }
        echo "</table></container>";

        $result->close();
    }
    else // show the sign up and sign in form if user is not in sign in status
    {
        header("location:login.php");
        exit;
    }

    $conn->close();

    function get_post($conn, $var)
    {
        return $conn->real_escape_string($_POST[$var]);
    }

?>