<?php

    session_start();
    require_once 'mysql_parameter.php';
    // connect to database
    $conn = mysqli_connect($hn, $un, $pw, $db, $port);
    if ($conn->connect_error) die($conn->connect_error);

    $role = $_SESSION['role'];
    if( $role == "contributor" ) {
        // store user input and text content to database
        if (isset($_FILES['file']) && isset($_POST['malware_name'])){
            
            // check the file is whether uploaded or not
            if ($_FILES['file']['tmp_name'] === '' || $_POST['malware_name'] === ''){
                $_SESSION['message'] = "Please upload a file and enter a new file name.";
                
            }
            else
            {
                
                
                ///get end of header
                $endOfFileHeader = 0;
                
                //                         Header size of different file types
                //                         type       size (bytes)
                //                         docx      8
                //                         txt       0
                //                         png       8
                //                         jpeg      4
                //                         pdf       4
                
                //                         xlsx      8
                //                         exe       2
                //                         mp3       3
                $errors = array();
                $ext = "default";
                switch($_FILES['file']['type']) {
                    case 'text/plain':
                        $ext = 'txt';
                        break;
                    case 'application/vnd.openxmlformats-officedocument.wordprocessingml.document':
                        $endOfFileHeader = 8;
                        $ext = 'docx';
                        break;
                    case 'image/png':
                        $endOfFileHeader = 8;
                        $ext = 'png';
                        break;
                    case 'image/jpeg':
                        $endOfFileHeader = 10;
                        $ext = 'jpg';
                        break;
                    case 'application/pdf':
                        $endOfFileHeader = 4;
                        $ext = 'pdf';
                        break;
                    case 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':
                        $endOfFileHeader = 8;
                        $ext = 'xlsx';
                        break;
                    case 'application/octet-stream':
                        $endOfFileHeader = 8;
                        $ext = 'exe';
                        break;
                    case 'audio/mpeg':
                        $endOfFileHeader = 3;
                        $ext = 'mp3';
                        break;
                    default:
                        $ext = '';
                        break;
                }
      

                if (empty($errors) == true) {			
                    if (preg_match("%^[A-Za-z0-9]{4,128}$%", $_POST["malware_name"])){
                        
                        $content = addslashes($_FILES['file']['tmp_name']);
                        $content = file_get_contents($content);
                        $content = base64_encode($content);
                        
                        
                        
                        $malware_name = get_post($conn, 'malware_name');
                        
                        $sequence_of_bytes = substr($content, $endOfFileHeader , 20);
                        
                        $username = $_SESSION['username'];
            
                        $query = "INSERT INTO contributedmalwares (name, bytes, content, username) VALUES " .
                            "('$malware_name', '$sequence_of_bytes', '$content', '$username')";
                        $upload_result = $conn->query($query);
            
                        if (!$upload_result)
                        {
                            echo "INSERT failed.<br>" . $conn->error . "<br><br>";
                        }
                        else{
                            header("location:contributor.php");
                            exit;
                        }
                    } else {
                        $_SESSION['message'] = "Error: Please enter a valid malware name.";
                        
                    }
                }
                else echo "Error: The file you upload is not an accepted text file."; 
            }
        }

        // check whether user is in a login status
        if (isset($_SESSION['username']))
        {
            // Html form for uploading and rename the file
            echo <<<_END
            <html>
                <head>
                    <title>Online Virus Check</title>
                    <link rel="stylesheet" type="text/css" href="style.css">
                </head>
                <body>
                    <div class="header">
                        <h1>Online Virus Check</h1>
                    </div>
_END;
                    if (isset($_SESSION['message'])) {
                        echo "<div id='error_msg'>" . $_SESSION['message'] . "</div>";
                        
                    }
            echo <<<_END
                    <form action="contributor.php" method="post" enctype="multipart/form-data">
                            <input type="file" name="file">
                            <br>
                            <br>
                            Select a file you would like to have reviewdd as malware:
                            <input type="text" name="malware_name">
                            <br>
                            Please use characters of "A-Z", "a-z", "0-9" to create a malware name. No spaces. The length of malware name is from 4 to 128 characters.
                            <br>
                            <br>
                            <input type="submit" value="Submit">
                    </form>
                    <form class="logout" action="logout.php">
                            <input type="submit" name="logout" value="Logout" />
                    </form>
                </body>
            </html>
_END;
            $username = $_SESSION['username'];
            
            // print out all the file from database
            $query = "SELECT * FROM contributedmalwares WHERE username = '$username'";
            $result = $conn->query($query);
            if (!$result) die($conn->error);

            $rows = $result->num_rows;

            echo	"<div class='container'><table><tr><th>Malware name</th><th>Sequence of bytes</th><th>Content</th><th>Upload user</th><th>Status</th></tr>";
            for ($j = 0 ; $j < $rows ; ++$j)
            {
                $result->data_seek($j);
                $row = $result->fetch_array(MYSQLI_NUM);
                echo "<tr>";

                for ($k = 1 ; $k <= 5 ; ++$k) echo "<td>$row[$k]</td>";
                echo "</tr>";
            }
            echo "</table></container>";

            $result->close();
        }
        else // show the sign up and sign in form if user is not in sign in status
        {
            header("location:login.php");
            exit;
        }

        $conn->close();


    } else {
        header("location:login.php");
        exit;
    }

    function get_post($conn, $var)
    {
        return $conn->real_escape_string($_POST[$var]);
    }

    function mysql_entities_fix_string($conn, $string)
	{
		return htmlentities(mysql_fix_string($conn, $string));
	}

	function mysql_fix_string($conn, $string)
	{
		if (get_magic_quotes_gpc()) $string = stripslashes($string);
		return $conn->real_escape_string($string);
	}
?>