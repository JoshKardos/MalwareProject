<?php

    session_start();
    require_once 'mysql_parameter.php';

    // connect to database
    $conn = mysqli_connect($hn, $un, $pw, $db, $port);
    if ($conn->connect_error) die($conn->connect_error);

    $min = 4;
    $max = 128;
    $role = $_SESSION['role'];
    if( $role == "admin" ) {

        // store user input and text content to database
        if (isset($_FILES['file']) && isset($_POST['malware_name'])){
            // check the file is whether uploaded or not
            if ($_FILES['file']['tmp_name'] === '' || $_POST['malware_name'] === '')
            {
                $_SESSION['message'] = "Please upload a text file, enter a new file name.";
                
            }
            else
            {
                
                
                
                
                ///get end of header
                $endOfFileHeader = 0;
                
                //                         Header size of different file types
                //                         type       size (bytes)
                //                         docx      8
                //                         txt       0
                //                         png       8
                //                         jpeg      4
                //                         pdf       4
                
                //                         xlsx      8
                //                         exe       2
                //                         mp3       3
                $errors = array();
                $ext = "default";
                switch($_FILES['file']['type']) {
                    case 'text/plain': 
                        $ext = 'txt'; 
                        break;   
                    case 'application/vnd.openxmlformats-officedocument.wordprocessingml.document':
                        $endOfFileHeader = 8;
                        $ext = 'docx';
                        break;
                    case 'image/png':
                        $endOfFileHeader = 8;
                        $ext = 'png';
                        break;
                    case 'image/jpeg':
                        $endOfFileHeader = 10;
                        $ext = 'jpg';
                        break;
                    case 'application/pdf':
                        $endOfFileHeader = 4;
                        $ext = 'pdf';
                        break;
                    case 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':
                        $endOfFileHeader = 8;
                        $ext = 'xlsx';
                        break;
                    case 'application/octet-stream':
                        $endOfFileHeader = 2;
                        $ext = 'exe';
                        break;
                    case 'audio/mpeg':
                        $endOfFileHeader = 3;
                        $ext = 'mp3';
                        break;
                    default: 
                        $ext = ''; 
                        break;
                }
                
                if (empty($errors) == true) {	

                    if (preg_match("%^[A-Za-z0-9]{4,128}$%", $_POST["malware_name"])){

                        $content = addslashes($_FILES['file']['tmp_name']);
                        $content = file_get_contents($content);
                        $content = base64_encode($content);
                        
                        
                        
                        $malware_name = get_post($conn, 'malware_name');
                           
                        $sequence_of_bytes = substr($content, $endOfFileHeader , 20);
                        
                        $username = $_SESSION['username'];
            
                        $query = "INSERT INTO malwares (name, bytes, content, username) VALUES " .
                            "('$malware_name', '$sequence_of_bytes', '$content', '$username')";
                        $upload_result = $conn->query($query);
            
                        if (!$upload_result)
                        {
                            echo "INSERT failed.<br>" . $conn->error . "<br><br>";
                        }
                        else{
                            header("location:admin_dashboard.php");
                            exit;
                        }
                        $upload_result->close();
                    } else {
                        $_SESSION['message'] = "Error: Please enter a valid malware name.";
                        
                    }
                }
                else echo "Error: The file you uploaded was not an acceptable file."; 
            }
        }

        // approval button function
        if (isset($_POST['approve_btn'])) {
    
            $ap_malware_name = $_POST['ap_malware_name'];
            $sql = "SELECT * FROM contributedmalwares WHERE name = '$ap_malware_name'";
            
            // $result = mysqli_query($conn, $sql);
            $result = $conn->query($sql);
            if (!$result) die($conn->error);
            
            if ($result) {
                $rows = $result->num_rows;
                $cname = "";
                $cbytes = "";
                $content = "";
                $username = "";

                for ($j = 0 ; $j < $rows ; ++$j)
                {
                    $result->data_seek($j);
                    $row = $result->fetch_array(MYSQLI_NUM);

                    $cname = $row[1];
                    $cbytes = $row[2];
                    $ccontent = $row[3];
                    $cusername = $row[4];
                }
                // update the awaiting approval status to 'Approved' status in the contributedmalware
                $sql = "UPDATE `contributedmalwares` SET `status` = 'Approved' WHERE name = '$ap_malware_name'";
                $result = mysqli_query($conn, $sql);
                
                if (!$result) die($conn->error);

                // save the approval contributed malware into malware table
                $sql = "INSERT INTO malwares (name, bytes, content, username) VALUES " .
                        "('$cname', '$cbytes', '$ccontent', '$cusername')";
                $result = mysqli_query($conn, $sql);

                if (!$result) die($conn->error);

                // $_SESSION['message'] = "$cname$cbytes$ccontent$cusername";
                header("location: admin_dashboard.php");
            } else {
                $_SESSION['message'] = "Malware is not existed.";
            }
    
            $result->close();
        }
        
        // deny button function
        if (isset($_POST['deny_btn'])) {
            
            $ap_malware_name = $_POST['ap_malware_name'];
            
            
            // $sql = "DELETE FROM contributedmalwares WHERE name = '$ap_malware_name'";
            $sql = "UPDATE `contributedmalwares` SET `status` = 'Denied' WHERE name = '$ap_malware_name'";
            $result = mysqli_query($conn, $sql);
            
            if (!$result) die($conn->error);
            
            
            header("location: admin_dashboard.php");

            $result->close();
        }

        // check whether user is in a login status
        if (isset($_SESSION['username']))
        {
            // Html form for uploading and rename the file
            echo <<<_END
            <html>
                <head>
                    <title>Online Virus Check</title>
                    <link rel="stylesheet" type="text/css" href="style.css">

                    <script>
                    function validate(form) {
                        fail += validateMalwareName(form.malware_name.value)
                        
                        if (fail == "") return true
                        else { alert(fail); return false }
                    }
        
                    function validateMalwareName(field)
                    {
                        if (field == "") return "No Username was entered."
                        else if (field.length < $min)
                            return "Usernames must be at least $min characters."
                        else if (/[^a-zA-Z0-9]/.test(field))
                            return "Only a-z, A-Z, 0-9 allowed in Usernames."
                        return ""
                    }

                </script>
                </head>
                <body>
                    <div class="header">
                        <h1>Online Virus Check</h1>
                        <h2>Admin</h2>
                    </div>
_END;
                    if (isset($_SESSION['message'])) {
                        echo "<div id='error_msg'>" . $_SESSION['message'] . "</div>";
                        
                    }
            echo <<<_END
                    <form action="admin_dashboard.php" method="post" enctype="multipart/form-data">
                            Select a File to upload as malware:
                            <input type="file" name="file">
                            <br>
                            <br>
                            Please enter the malware name: 
                            <input type="text" name="malware_name">
                            <br>
                            Please use characters of "A-Z", "a-z", "0-9" to create a malware name. No spaces. The length of malware name is from 4 to 128 characters.                            <br>
                            <br>
                            <br>
                            <input type="submit" value="Submit">
                    </form>
                    <form class="logout" action="logout.php">
                            <input type="submit" name="logout" value="Logout" />
                    </form>
                </body>
            </html>
_END;
            $username = $_SESSION['username'];
            
            // print out all the file from database
            $query = "SELECT * FROM malwares";
            $result = $conn->query($query);
            if (!$result) die($conn->error);

            $rows = $result->num_rows;

            echo	"<div class='container'><table ><tr><th>Malware name</th><th>Signature</th><th>Upload user</th></tr>";
            for ($j = 0 ; $j < $rows ; ++$j)
            {
                $result->data_seek($j);
                $row = $result->fetch_array(MYSQLI_NUM);
                echo "<tr>";
                echo "<td>$row[1]</td>";//name
                echo "<td>$row[2]</td>";//seq of bytes
                // echo "<td></td>";//$row[3]</td>";//not displaying content
                echo "<td>$row[4]</td>";//user that uploaded                
                echo "</tr>";
            }
            echo "</table></container>";

            // print out all the contributed malware
            echo <<<_END
            <h2>== Waitting for approval list below ==</h2>
_END;
            $cquery = "SELECT * FROM contributedmalwares where status = 'Submitted'";
            $cresult = $conn->query($cquery);
            if (!$cresult) die($conn->error);

            $rows = $cresult->num_rows;

            echo	"<div class='container'><table><tr><th>Malware name</th><th>Sequence of bytes</th><th>Upload user</th></tr>";
            for ($j = 0 ; $j < $rows ; ++$j)
            {
                $cresult->data_seek($j);
                $row = $cresult->fetch_array(MYSQLI_NUM);
                echo "<tr>";

                // for ($k = 1 ; $k <= 4 ; ++$k) echo "<td>$row[$k]</td>";
                echo "<td>$row[1]</td>";//name
                echo "<td>$row[2]</td>";//seq of bytes
                // echo "<td></td>";//$row[3]</td>";//not displaying content
                echo "<td>$row[4]</td>";//user that uploaded  
                echo "<td> <form action='admin_dashboard.php' method='post'>
                    <input type='hidden' name='ap_malware_name'  value='$row[1]'>
                    <input type='submit' name='approve_btn' value='Approve'>
                    <input type='submit' name='deny_btn' value='Deny'>
                    </form></td>";
                echo "</tr>";
            }
            echo "</table></div>";

            $result->close();
            $cresult->close();
        }
        else // show the sign up and sign in form if user is not in sign in status
        {
            header("location:login.php");
            exit;
        }

        $conn->close();

    } else {
        header("location:login.php");
        exit;
    }

    function get_post($conn, $var)
    {
        return $conn->real_escape_string($_POST[$var]);
    }

    function mysql_entities_fix_string($conn, $string)
	{
		return htmlentities(mysql_fix_string($conn, $string));
	}

	function mysql_fix_string($conn, $string)
	{
		if (get_magic_quotes_gpc()) $string = stripslashes($string);
		return $conn->real_escape_string($string);
	}

?>