
<?php
session_start();
require_once 'mysql_parameter.php';

// connect to database
$db = mysqli_connect($hn, $un, $pw, $db, $port);
if ($db->connect_error) die($db->connect_error);
if (isset($_POST['register_btn'])) {

	$role = mysqli_real_escape_string($db, $_POST['role']);

	$username = mysqli_real_escape_string($db, $_POST['username']);

    $email = mysqli_real_escape_string($db, $_POST['email']);
    $password = mysqli_real_escape_string($db, $_POST['password']);
	$password2 = mysqli_real_escape_string($db, $_POST['password2']);

	if ($password == $password2 && $password != ""
		&& preg_match('/^(?=.*\d)(?=.*[A-Za-z])[0-9A-Za-z!@#$%]{4,128}$/', $_POST["password"])
		&& preg_match("%^[A-Za-z0-9-_@!]{4,128}$%", $_POST["username"])
		) {
		// create user
		if($role == 'user'){
			$token = hash('ripemd128', "$salt1$password$salt2");

			$sql = "INSERT INTO users(username, email, password) VALUES('$username', '$email', '$token')";
			mysqli_query($db, $sql);
			$_SESSION['message'] = "You are now logged in";
			$_SESSION['username'] = $username;
			header("location: home.php");
		} elseif ($role == 'contributor') {
			$token = hash('ripemd128', "$salt1$password$salt2");

			$sql = "INSERT INTO contributors (username, email, password) VALUES('$username', '$email', '$token')";
			mysqli_query($db, $sql);
			$_SESSION['contributors'] = "You are now logged in";
			$_SESSION['username'] = $username;
			// need to create a contributors upload page!!!!!!!!!!!!!
			header("location: contributor.php");
		}

    } elseif(empty($username) || empty($email) || empty($password) || empty($password2)){
        
        $_SESSION['message'] = "There is an empty field!";
        
	} else{
        // failed
		$_SESSION['message'] = "Please make sure enter the same passwords, a valid username, a valid password, and a valid length of password and username.";
    }
}

	echo <<<_END
		<!DOCTYPE html>
		<html>
		<head>
		<title>Online Virus Check</title>
		<link rel="stylesheet" type="text/css" href="style.css">
		</head>
		<body>
			<div class="header">
				<h1>Online Virus Check</h1>
			</div>
_END;


	if (isset($_SESSION['message'])) {
		echo "<div id='error_msg'>" . $_SESSION['message'] . "</div>";
		unset($_SESSION['message']);
	}

	echo <<<_END
		<form method="post" action="register.php">
			<table>
				<tr>
					<select id="role" name="role">                      
						<option selected="selected" value="user">User</option>
						<option value="contributor">Contributor</option>
					</select>
				</tr>
				<tr>
					<td>Username:</td>
					<td><input type="text" name="username" class="textInput"></td>
				</tr>

				<tr>
					<td></td>
					<td>
						Please enter English letters (capitalized or not), digits, and the characters '_' (underscore) and '-' (dash). Nothing else. Also the minimun number of characters is 4.
					</td>
				</tr>

				<tr>
					<td>Email:</td>
					<td><input type="email" name="email" class="textInput"></td>
				</tr>

				<tr>
					<td>Password:</td>
					<td><input type="password" name="password" class="textInput"></td>
				</tr>

				<tr>
					<td></td>
					<td>
						Please use characters of "A-Z", "a-z", "0-9", or "!@#$%" to create your password. The length of password is from 4 to 128 characters. The password must be at least one letter and at least one number.
					</td>
				</tr>

				<tr>
					<td>Re-enter password:</td>
					<td><input type="password" name="password2" class="textInput"></td>
				</tr>

				<tr>
					<td><a href="login.php">Log In</a></td>
					<td><input type="submit" name="register_btn" value="Register"></td>
				</tr>

			</table>
		</form>



	</body>
	</html>
_END;
?>